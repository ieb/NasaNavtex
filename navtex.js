



export const navtexStations = {
    navareas: {
        'I': {
            title: 'North Atlantic, North Sea, Baltic Sea',
            'a': {
                'A':'Svalbard NOR',
                'B': 'Bodø    NOR', 
                'C': 'Vardø   NOR', 
                'D': 'Tórshavn    FRO', 
                'E': 'Niton   GBR', 
                'G': 'Cullercoats GBR', 
                'H': 'Bjuröklubb  SWE', 
                'I': 'Grimeton    SWE', 
                'J': 'Gislövshammar SWE',
                'K': 'Niton   GBR', 
                'L': 'Rogaland    NOR', 
                'M': 'Jeløy   NOR', 
                'N': 'Ørlandet    NOR', 
                'O': 'Portpatrick GBR', 
                'P': 'Netherlands Coastguard  NLD', 
                'Q': 'Malin Head  IRL', 
                'R': 'Saudanes    ISL', 
                'S': 'Pinneberg   DEU', 
                'T': 'Oostende    BEL', 
                'F': 'Tallinn EST', 
                'V': 'Oostende    BEL', 
                'W': 'Valentia    IRL', 
                'X': 'Grindavik   ISL' 
            },
            'b': {
                'B': 'Oostende    BE',
                'C': 'Portpatrick GBR',
                'E': 'Saudanes    ISL',
                'I': 'Niton   GBR',
                'K': 'Grindavik   ISL',
                'L': 'Pinneberg   DEU',
                'U': 'Cullercoats GBR'
            },
            '1': {
                'U': 'Navarea 1'                
            },
            'c': {
                'U': 'UK Coastal'
            }
        },
        "II": {
            title: 'East Atlantic',
            'a': {
                'A':  'Cross Corsen    FRA',
                'D':  'Coruna  ESP',
                'F':  'Horta   POR',
                'G':  'Tarifa  ESP',
                'I':  'Las Palmas  ESP',
                'M':  'Casablanca  MRC',
                'P':  'Porto Santo POR',
                'R':  'Monsanto    POR',
                'U':  'Ribeira de Vinha    CPV',
                'X':  'Cabo La Nao ESP'
            },
            'b': {
                'A':  'Las Palmas  ESP',
                'E':  'Cross Corsen    FRA',
                'G':  'Monsanto    POR',
                'J':  'Horta   POR',
                'M':  'Porto Santo POR',
                'M':  'Cabo La Nao ESP',
                'P':  'São Vicente CPV',
                'T':  'Niton   GBR',
                'T':  'Tarifa  ESP',
                'W':  'Coruna  ESP',
            }

        },
        "III": {
            title: 'Mediterranean Sea',
            'a': {
                'A':  'Novorossijsk    RUS',
                'B':  'Algiers ALG',
                'B':  'Kerch   RUS',
                'C':  'Odesa   UKR',
                'D':  'Istanbul    TUR',
                'E':  'Samsun  TUR',
                'F':  'Antalya TUR',
                'H':  'Iraklio GRC',
                'I':  'İzmir   TUR',
                'J':  'Varna   BUL',
                'K':  'Kerkyra GRC',
                'L':  'Limnos  GRC',
                'M':  'Cyprus  CYP',
                'N':  'Alexandria  EGY',
                'O':  'Malta   MLT',
                'P':  'Haifa   ISR',
                'Q':  'Split   HRV',
                'R':  'La Maddalena    ITA',
                'T':  'Kelibia TUN',
                'U':  'Mondolfo    ITA',
                'V':  'Sellia Marina   ITA',
                'W':  'Cross La Garde  FRA',
                'X':  'Cabo de la Nao  ESP'
            },
            'b': {
                'A':  'Samsun  TUR',
                'B':  'Istanbul    TUR',
                'C':  'İzmir   TUR',
                'D':  'Antalya TUR',
                'E':  'Mondolfo    ITA',
                'I':  'La Maddalena    ITA',
                'L':  'Constanța   ROU',
                'M':  'Cabo de la Nao  ESP',
                'N':  'Piombino    ITA',
                'P':  'Kerkyra GRC',
                'Q':  'Iraklio GRC',
                'R':  'Limnos  GRC',
                'S':  'Cross La Garde  FRA',
                'W':  'Sellia Marina   ITA'

            }

        },
        "IV": {
            title: 'West Atlantic',
            'a': {
                'A':  'Miami   USA',
                'B':  'Bermuda Harbour BER',
                'C':  'Rivière-au-Renard   CAN',
                'E':  'Charleston  USA',
                'E':  'Savannah    USA',
                'F':  'Boston  USA',
                'G':  'New Orleans USA',
                'H':  'Wiarton CAN',
                'H':  'Curacao NLD',
                'N':  'Portsmouth  USA',
                'O':  "St. John's  CAN",
                'P':  'Thunder Bay CAN',
                'Q':  'Sydney (Nova Scotia)    CAN',
                'R':  'Isabela (Puerto Rico)   USA',
                'T':  'Iqaluit CAN',
                'U':  'Saint John (Yarmouth)   CAN',
                'W':  'Kook Island (Nuuk)  DNK',
                'X':  'Labrador    CAN'
            },
            'b': {
                'D':  'Rivière-au-Renard   CAN',
                'J':  'Sydney (Nova Scotia)    CAN',
                'S':  'Iqaluit CAN',
                'V':  'Yarmouth    CAN'
            }

        },
        "V": {
            title: 'Brasil (none use Imarsat C)',
            'a': {},
            'b': {},

        },
        "VI": {
            title: 'Argentina, Uruguay',
            'a': {
                'F':  'La Paloma   URG',
                'M':  'Ushuaia ARG',
                'N':  'Rio Gallegos    ARG',
                'O':  'Comodoro Rivadavia  ARG',
                'P':  'Bahía Blanca    ARG',
                'Q':  'Mar del Plata   ARG',
                'R':  'Buenos Aires    ARG'
            },
            'b': {
                'A':  'La Paloma   URG',
                'A':  'Ushuaia ARG',
                'B':  'Rio Gallegos    ARG',
                'C':  'Comodoro Rivadavia  ARG',
                'D':  'Bahía Blanca    ARG',
                'E':  'Mar del Plata   ARG',
                'F':  'Buenos Aires    ARG'
            }


        },
        "VII": {
            title: 'South Africa',
            'a': {
                'B':  'Walvis Bay  NMB',
                'C':  'Cape Town   AFS',
                'I':  'Port Elizabeth  AFS',
                'O':  'Durban  AFS'
            },
            'b': {}

        },
        "VIII": {
            title: 'India',
            'a': {
                'C':  'Mauritius   MAU',
                'G':  'Bombay  IND',
                'P':  'Madras  IND'
            },
            'b': {}

        },
        "IX": {
            title: 'Arabia',
            'a': {
                'A':  'Bushehr IRN',
                'B':  'Hamala  BHR',
                'F':  'Bandar Abbas    IRN',
                'H':  'Jeddah  ARS',
                'M':  'Muscat  OMA',
                'P':  'Karachi PAK',
                'V':  'Quseir  EGY',
                'X':  'Serapeum (Ismailia) EGY'
            },
            'b': {}

        },
        "X": {
            title: 'Australia, Imarsat C only',
            'a': {},
            'b': {}

        },
        "XI": {
            title: 'East Asia',
            'a': {
                'A':  'Jayapura    INS',
                'B':  'Ambon   INS',
                'C':  'Singapore   SNG',
                'D':  'Makassar    INS',
                'E':  'Jakarta INS',
                'E':  'Hungnam KRE',
                'F':  'Bangkok THA',
                'G':  'Naha    JPN',
                'H':  'Moji    JPN',
                'I':  'Puerto Princesa',
                'I':  'Yokohama    JPN',
                'J':  'Manila  PHL',
                'J':  'Otaru   JPN',
                'K':  'Davao City',
                'K':  'Kushiro JPN',
                'L':  'Hongkong    HKG',
                'M':  'Sanya   CHN',
                'N':  'Guangzhou   CHN',
                'O':  'Fuzhou  CHN',
                'P':  'Da Nang',
                'P':  'Chilung TWN',
                'P':  'Kaohsiung   TWN',
                'Q':  'Shanghai    CHN',
                'R':  'Dalian  CHN',
                'S':  'Sandakan    MLA',
                'T':  'Miri    MLA',
                'U':  'Penang  MLA',
                'V':  'Guam    GUM',
                'V':  'Jukbyeon    KOR',
                'W':  'Byeonsan    KOR',
                'X':  'Ho Chi',
            },
            'b': {
                'J':  'Jukbyeon    KOR',
                'K':  'Byeonsan    KOR',
                'W':  'Hai Phong   VTN'
            }

        },
        "XII": {
            title: 'Eastern Pacific',
            'a': {
                'C':  'San Francisco',
                'D':  'Prince Rupert',
                'H':  'Tofino  CAN',
                'J':  'Kodiak  ALS',
                'L':  'Ayora   EQA',
                'M':  'Guayaquil   EQA',
                'O':  'Honolulu    HWA',
                'Q':  'Cambria USA',
                'W':  'Astoria USA',
                'X':  'Kodiak  ALS' 
            },
            'b': {
                'A':  'Ayora   EQA',
            }

        },
        "XIII": {
            title: 'Russia',
            'a': {
                'B':  'Kholmsk RUS',
                'C':  'Murmansk    RUS',
                'F':  'Archangelsk RUS',
                'C':  'Petropavlosk    RUS',
                'W':  'Astrakhan   RUS',
                'A':  'Vladivostok RUS',
                'G':  'Okhotsk RUS',
                'D':  'Magadan RUS',
            }

        },
        "XIV": {
            title: 'New Zealand, Southern Pacific, none',
            'a': {},
            'b': {}

        },
        "XV": {
            title: 'Chile',
            'a': {
                'A':  'Antofagasta CHL',
                'B':  'Valparaíso  CHL',
                'C':  'Talcahuano  CHL',
                'D':  'Puerto Montt',
                'E':  'Punta Arenas',
                'F':  'Easter Island'
            },
            'b': {
                'G':  'Easter Island',
                'H':  'Antofagasta CHL',
                'I':  'Valparaíso  CHL',
                'J':  'Talcahuano  CHL',
                'K':  'Puerto Montt',
                'L':  'Punta Arenas'
            }

        },
        "XVI": {
            title: 'Peru',
            'a': {
                'S':  'Paita   PRU',
                'U':  'Callao  PRU',
                'W':  'Mollendo    PRU'
            },
            'b': {}
        },

    },
    messageTypes: {
        'A':  'Navigational warnings',
        'B':  'Meteorological warnings',
        'C':  'Ice reports',
        'D':  'Search & rescue, and pirate warnings',
        'E':  'Meteorological forecasts',
        'F':  'Pilot service',
        'G':  'AIS messages',
        'H':  'LORAN messages',
        'I':  'OMEGA messages',
        'J':  'SATNAV messages',
        'K':  'Other electronic',
        'L':  'Navigational warnings',
        'T':  'Test transmissions',
        'V':  'Notice to fishermen',
        'W':  'Environmental',
        'X':  'Special services',
        'Y':  'Special services',
        'Z':  'No message'
    }
}    



// Assume only the MLDP service exists const TANSPARENT_PRIVATE_SERVICE_UUID = "49535343-fe7d-4ae5-8fa9-9fafd205e455"

function str2arr(str) {
    var array = new ArrayBuffer(str.length);
    var bufferView = new Uint8Array(array);
    for (var i = 0; i < str.length; i++) {
        bufferView[i] = str.charCodeAt(i);
    }
    return bufferView;
}


export class NasaNavtex {
    static MLDP_PRIVATE_SERVICE_UUID = "00035b03-58e6-07dd-021a-08123a000300";

    static MLDP_DATA_PRIVATE_CHAR_UUID = "00035b03-58e6-07dd-021a-08123a000301";
    static MLDP_CONTROL_PRIVATE_CHAR_UUID = "00035b03-58e6-07dd-021a-08123a0003ff";



    constructor() {

    }


    async connect() {
        const options = {
          filters: [
            { namePrefix: 'BtNavtex' },
            { services: [NasaNavtex.MLDP_PRIVATE_SERVICE_UUID] },
          ],
        };

        try {
            console.log('Requesting Bluetooth Device...');
            console.log(`with ${JSON.stringify(options)}`);
            this.device = await navigator.bluetooth.requestDevice(options);

            console.log(`> Name:             ${this.device.name}`);
            console.log(`> Id:               ${this.device.id}`);
            console.log(`> Connected:        ${this.device.gatt.connected}`);

            const ondisconnect = () => {
                console.log('server disconnected');
                this.device.removeEventListener('gattserverdisconnected', ondisconnect);
            };
            this.device.addEventListener('gattserverdisconnected', ondisconnect);

            this.server = await this.device.gatt.connect();


            this.mdlpService = await this.server.getPrimaryService(NasaNavtex.MLDP_PRIVATE_SERVICE_UUID);
            this.dataStream = await this.mdlpService.getCharacteristic(NasaNavtex.MLDP_DATA_PRIVATE_CHAR_UUID);

            await this.dataStream.startNotifications();

            return true;
        } catch (e) {
            console.log(e);
            return false;
        }
    }

    async disconnect() {
        await this.dataStream.stopNotifications();
        this.server.disconnect();
        this.dataStream = undefined;
        this.mdlpService = undefined;
        this.device = undefined;
        console.log('Disconnected')
    }



    sendRequest(request, endMsg) {
    	endMsg = endMsg || (() => false);
        return new Promise((resolve)=> {
                console.debug("Starting ", request);
                let msg = '';
                const interval = setInterval(() => {
                    console.debug("msg", JSON.stringify(msg))
                }, 2000);
                const td = new TextDecoder();
                const listener = (event) => {

                    const c = td.decode(event.target.value);
                    msg = msg+c;
                    const startChar = msg.charAt(0);
                    if (msg.endsWith(',end\r') 
                        || msg.endsWith('\r\nn\n')
                        || msg == 'n\n'
                        || msg.endsWith('\r\n\n')
                        || endMsg(msg)
                        || msg === 'Command not recognized.') {
                        console.debug('end message detected', msg)
                        this.dataStream.removeEventListener('characteristicvaluechanged', listener);
                        clearInterval(interval);
                        resolve(msg);
                    }
                };
                this.dataStream.addEventListener('characteristicvaluechanged', listener);
                this.dataStream.writeValueWithoutResponse(str2arr(request)).then(()=> {
                    console.debug("done sending");
                });
            })
    }

    async sync(cb, messages, pincode) {;
        cb = cb || (() => {})
        messages = messages || {};

        const now = new Date();
        const hours = ('00'+now.getUTCHours()).slice(-2);
        const mins = ('00'+now.getUTCMinutes()).slice(-2);
        cb('status', `set time to ${hours}:${mins}`);
        // documented as $C,PPPP,hh:mm, but was $C,hh:mm~
        const settime = await this.sendRequest(`$C,${hours}:${mins}~`, (msg) => msg.endsWith("UTC\r\n"));
        cb('settime', settime);

        if (pincode) {

	        cb('status', `set 512KHz active at 00:00 and 18:00`);
	        const setswitchA = await this.sendRequest(`$A,${pincode},00:00,18:00~`)
	        cb('setswitchA', setswitchA);


	        cb('status', `set 490KHz active at 05:00 and 03:00`);
	        const setswitchB = await this.sendRequest(`$B,${pincode},15:00,03:00~`)
	        cb('setswitchB', setswitchB);        	
        }

	    cb('status', `set duplicatee headers off`);
        const duplicateHeadersOff = await this.sendRequest('$H~');
        cb('duplicateHeadersOff', duplicateHeadersOff);

        const settings = await this.sendRequest('$#~');
        cb('settings', settings);

	    cb('status', `get messages ids`);
        const messageIds = (await this.sendRequest('$L~')).split(',');
        cb('messageIds', messageIds);
        const tofetch = [];
        const fetched = [];
        const skipped = [];
        const notfound = [];
        for (var i = 0; i < messageIds.length; i++) {
            const id =  messageIds[i].trim();
            if ( id !== 'end') {
	            if ( messages[id] != undefined && messages[id].fecErrors == 0) {
	            	skipped.push(id);
	            }  else {
	            	tofetch.push(id);
	            }
	        }

        }
	    cb('status', `skip:${skipped.length} fetching:0 of ${tofetch.length}`);

        for (var ix = 0; ix < tofetch.length; ix++) {
		    cb('status', `skip:${skipped.length} fetching:${ix+1} of ${tofetch.length}`);
		    const id = tofetch[ix];
            const msg = await this.sendRequest(`$S,${id}~`);
            if (msg) {
            	fetched.push(id);
                cb(id, msg);	            	
            } else {
            	notfound.push(id);
            }
        }
        console.log({ fetched, skipped, notfound});

    }

}

